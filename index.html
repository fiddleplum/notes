<!doctype html>
<meta charset='UTF-8'>
<html>
	<head>
		<title>Notes</title>
		<meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=0'>
		<link rel='shortcut icon' href='icon16.png' sizes='16x16'>
		<link rel='shortcut icon' href='icon.png' sizes='152x152'>
		<link href='https://fonts.googleapis.com/css?family=Lora' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Oxygen+Mono' rel='stylesheet'>
		<link rel='stylesheet' type='text/css' href='style.css'>
		<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
		<script src='math.js'></script>
		<script src='mdeToHtml.js'></script>
		<script src='rfs/rfs.js'></script>
		<script src='rfs/google_drive.js'></script>
		<script>
			function getQueryParams() {
				let params = {}
				let questionMarkIndex = window.location.href.indexOf('?');
				if (questionMarkIndex != -1) {
					let pairs = window.location.href.substr(questionMarkIndex + 1).split('&');
					for (i in pairs) {
						let keyValue = pairs[i].split('=', 2);
						if (keyValue.length == 2) {
							params[keyValue[0]] = decodeURIComponent(keyValue[1].replace(/\+/g, '%20'));
						}
					}
				}
				return params;
			}

			function getCookies(cname) {
				let cookies = {}
				let name = cname + '=';
				let decodedCookie = decodeURIComponent(document.cookie);
				let ca = decodedCookie.split(';');
				for (let i = 0; i < ca.length; i++) {
					let c = ca[i];
					while (c.charAt(0) == ' ') {
						c = c.substring(1);
					}
					let t = c.split('=');
					cookies[t[0]] = t[1];
				}
				return cookies;
			}

			function showMessage(message) {
				let div = $('#message');
				if (message != '') {
					div.html(message);
					div.fadeIn(250);
				}
				else {
					div.fadeOut(250);
				}
			}

			function updateHtml() {
				idleTime = new Date();
				let scrolledToBottom = ($('#html')[0].scrollHeight - $('#html')[0].scrollTop - $('#html')[0].clientHeight == 0);
				let newMde = $('#mde')[0].value;
				if (!noteChanged && savedMde != newMde) {
					noteChanged = true;
					$('#title').html(note.name().substr(0, note.name().length - 4) + '*');
				}
				$('#html').html(mdeToHtml(newMde, $('#mde')[0].selectionStart));
				if ($('#cursor').length > 0) {
					let scrollTop = $('#html')[0].scrollTop + $('#cursor').offset().top - $('#html').offset().top - ($('#html')[0].clientHeight / 2);
					$('#cursor').remove();
					$('#html').animate({
						scrollTop: scrollTop
					}, 100);
				}
			}

			function checkIdle() {
				if (!noteChanged && (new Date().getTime() - idleTime.getTime() > 5 * 60 * 1000)) {
					window.location.replace('.?p=' + password + '&id=' + id);
				}
				setTimeout(checkIdle, 60 * 1000);
			}

			function swapViews() {
				if ($('#mde').is(":visible")) {
					$('#mde').fadeOut(200, function () {
						$('#html').fadeIn(200);
					});
				}
				else {
					$('#html').fadeOut(200, function () {
						$('#mde').fadeIn(200);
					});
				}
			}

			function swapColors() {
				if ($('#content').css('filter') == 'invert(1)') {
					$('#content').css('filter', 'invert(0%)');
					$('#signInButton').css('filter', 'invert(0%)');
					document.cookie = 'bw=n';
				}
				else {
					$('#content').css('filter', 'invert(100%)');
					$('#signInButton').css('filter', 'invert(100%)');
					document.cookie = 'bw=y';
				}
			}

			var params = getQueryParams();
			var cookies = getCookies();

			var password = params['p']; // the password
			var op = params['o']; // the operation
			var id = params['id']; // the name of the note

			var bw = cookies['bw'];

			var rfs = null // the RFS system
			var notesFolderId = ''; // the id of the Notes folder
			var note = null; // the RFS.Entry representing the id

			var noteChanged = false;
			var savedMde = '';
			var idleTime = new Date();

			window.addEventListener('load', function () {
				if (bw == 'y') {
					swapColors();
				}
				if (password == undefined) {
					showMessage("You need to specify a password!");
				}
				else {
					$.get('drive_api_key_' + password + '.txt', function (clientId) {
						rfs = new RFS.GoogleDrive(clientId, $('#signInButton')[0], getNotesFolderId);
					});
				}
			});
			window.addEventListener('resize', function () {
				if (window.innerWidth >= 1024) {
					$('#mde').removeAttr('style');
					$('#html').removeAttr('style');
				}
			});
			window.addEventListener('keyup', function (event) {
				if (op == 'e') {
					if (event.ctrlKey && event.shiftKey) {
						if (event.keyCode == 8 && !noteChanged) { // backspace
							window.location.replace('.?p=' + password + '&id=' + note.parentId());
						}
						else if (event.keyCode == 86 && !noteChanged) { // v
							window.location.replace('.?p=' + password + '&id=' + note.id());
						}
						else if (event.keyCode == 83) {
							save();
						}
					}
				}
				else {
					if (event.keyCode == 8 && note.id() != notesFolderId) { // backspace
						window.location.replace('.?p=' + password + '&id=' + note.parentId());
					}
					if (event.keyCode == 69 && !note.isFolder()) { // e
						window.location.replace('.?p=' + password + '&o=e&id=' + note.id());
					}
				}
			});

			function getNotesFolderId() {
				rfs.root(function (folder) {
					folder.child('Notes', function (folder) {
						if (folder == null) {
							root.createFolder('Notes', function (folder) {
								notesFolderId = folder.id();
								getNote();
							});
						}
						else {
							notesFolderId = folder.id();
							getNote();
						}
					});
				});
			}

			function getNote() {
				if (id != undefined && id != '') {
					rfs.get(id, function (entry) {
						note = entry;
						doOps();
					});
				}
				else {
					rfs.get(notesFolderId, function (entry) {
						note = entry;
						doOps();
					});
				}
			}

			function doOps() {
				if (op == 'e') {
					editNote();
					checkIdle();
				}
				else {
					if (note.isFolder()) {
						viewNotes();
					}
					else {
						viewNote();
					}
				}
			}

			function newNote(name) {
				if (name != '') {
					note.createFile(name + '.html', 'text/html', function (file) {
						note.createFile(name + '.mde', 'text/mde', function (file) {
							window.location.replace('.?p=' + password + '&o=e&id=' + file.id());
						});
					});
				}
			}

			function newFolder(name) {
				if (name != '') {
					note.createFolder(name, function (folder) {
						window.location.replace('.?p=' + password + '&id=' + folder.id());
					});
				}
			}

			function viewNotes() {
				note.list(function (entries) {
					let html = '';
					html += '<div id="title">' + note.name() + '</div>';

					html += '<div id="buttons">';
					html += '<a href="javascript:swapColors();"><img src="bw24.png"/></a>';
					html += '</div>';

					html += '<div id="new">';
					html += '<input id="new_name" type="text" />';
					html += '<a href="javascript:newNote($(\'#new_name\')[0].value);"><img src="newfile24.png"/></a> <a href="javascript:newFolder($(\'#new_name\')[0].value);"><img src="newfolder24.png"/></a>';
					html += '</div>';

					html += '<div class="clear"></div>';

					html += '<div id="list">';
					if (note.id() != notesFolderId) {
						html += '<li><a href=".?p=' + password + '&id=' + note.parentId() + '">..</a></li>';
					}
					let ids = Object.keys(entries);
					for (let i = 0; i < ids.length; i++) { // specially prefixed notes
						let id = ids[i];
						let name = entries[id];
						if (name.endsWith('.mde') && name.charCodeAt(0) < 65) {
							html += '<li><a href=".?p=' + password + '&id=' + id + '">' + name.substr(0, name.length - 4) + '</a> <a href="?p=' + password + '&id=' + id + '&o=e"><img src="edit24.png"/></a> <a href="javascript:if (confirm(\'Are you sure?\')) deleteNote(\'' + id + '\');"><img src="delete24.png"/></a></li>';
						}
					}
					for (let i = 0; i < ids.length; i++) { // folders
						let id = ids[i];
						let name = entries[id];
						if (!name.endsWith('.mde') && !name.endsWith('.html')) {
							html += '<li><a href=".?p=' + password + '&id=' + id + '">' + name + '</a> <a href="javascript:if (confirm(\'Are you sure?\')) deleteFolder(\'' + id + '\');"><img src="delete24.png"/></a></li>';
						}
					}
					for (let i = 0; i < ids.length; i++) { // everything else
						let id = ids[i];
						let name = entries[id];
						if (name.endsWith('.mde') && name.charCodeAt(0) >= 65) {
							html += '<li><a href=".?p=' + password + '&id=' + id + '">' + name.substr(0, name.length - 4) + '</a> <a href="?p=' + password + '&id=' + id + '&o=e"><img src="edit24.png"/></a> <a href="javascript:if (confirm(\'Are you sure?\')) deleteNote(\'' + id + '\');"><img src="delete24.png"/></a></li>';
						}
					}
					html += '</div>';
					$('#content').html(html);
				});
			}

			function viewNote() {
				note.load(function (data) {
					let html = '';
					html += '<div id="title">' + note.name().substr(0, note.name().length - 4) + '</div>';
					html += '<div id="buttons">';
					html += '<a href="javascript:swapColors();"><img src="bw24.png"/></a>';
					html += '<a href=".?p=' + password + '&o=e&id=' + id + '"><img src="edit24.png"/></a>';
					html += '<a href="javascript:if (confirm(\'Are you sure?\')) deleteNote(\'' + id + '\');"><img src="delete24.png"/></a>';
					html += '<a href=".?p=' + password + '&id=' + note.parentId() + '"><img src="list24.png"/></a>';
					html += '</div>';
					html += '<div id="html">';
					html += mdeToHtml(data);
					html += '</div>';
					$('#content').html(html);
				});
			}

			function editNote(mde) {
				note.load(function (data) {
					savedMde = data;
					var html = '';
					html += '<div id="title">' + note.name().substr(0, note.name().length - 4) + '</div>';
					html += '<div id="buttons">';
					html += '<a id="swapButton" href="javascript:swapViews();"><img src="swap24.png"/></a>';
					html += '<a href="javascript:save();"><img src="save24.png"/></a>';
					html += '<a href="javascript:swapColors();"><img src="bw24.png"/></a>';
					html += '<a href=".?p=' + password + '&o=v&id=' + id + '"><img src="view24.png"/></a>';
					html += '<a href="javascript:if (confirm(\'Are you sure?\')) deleteNote(\'' + id + '\');"><img src="delete24.png"/></a>';
					html += '<a href=".?p=' + password + '&id=' + note.parentId() + '"><img src="list24.png"/></a>';
					html += '</div>';
					html += '<textarea id="mde" onchange="updateHtml();" onkeyup="updateHtml();">';
					html += data;
					html += '</textarea>';
					html += '<div id="html">';
					html += mdeToHtml(data);
					html += '</div>';
					$('#content').html(html);
				});
			}

			function save() {
				showMessage('Saving...');
				var numSaved = 0;
				note.save($('#mde')[0].value, function () {
					numSaved += 1;
					if (numSaved == 2) {
						showMessage('');
						$('#title').html(note.name().substr(0, note.name().length - 4));
						savedMde = $('#mde')[0].value;
						noteChanged = false;
					}
				});
				rfs.get(note.parentId(), function (parentFolder) {
					parentFolder.child(note.name().substr(0, note.name().length - 4) + '.html', function (noteHtml) {
						noteHtml.save($('#html')[0].innerHTML, function () {
							numSaved += 1;
							if (numSaved == 2) {
								showMessage('');
								$('#title').html(note.name().substr(0, note.name().length - 4));
								savedMde = $('#mde')[0].value;
								noteChanged = false;
							}
						});
					});
				});
			}

			function deleteNote(id) {
				showMessage('Deleting...');
				rfs.get(id, function (noteMde) {
					rfs.delete(id, function () {
						rfs.get(noteMde.parentId(), function (parentFolder) {
							parentFolder.child(noteMde.name().substr(0, noteMde.name().length - 4) + '.html', function (noteHtml) {
								rfs.delete(noteHtml.id(), function () {
									window.location.replace('.?p=' + password + '&id=' + noteMde.parentId());
								});
							});
						});
					});
				});
			}

			function deleteFolder(id) {
				showMessage('Deleting...');
				rfs.get(id, function (folder) {
					rfs.delete(id, function () {
						window.location.replace('.?p=' + password + '&id=' + folder.parentId());
					});
				});
			}
		</script>
	</head>
	<body>
		<div id='signInButton'>...</div>
		<div id='message'></div>
		<div id='content'></div>
		<div id='clear'></div>
	</body>
</html>