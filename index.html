<!doctype html><meta charset='UTF-8'>
<html>
	<head>
		<title>Notes</title>
		<meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=0'>
		<link href='https://fonts.googleapis.com/css?family=Lora' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Oxygen+Mono' rel='stylesheet'>
		<link rel='stylesheet' type='text/css' href='style.css'>
		<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
		<script src='math.js'></script>
		<script src='mdeToHtml.js'></script>
		<script src='drive.js'></script>
		<script>
			function getQueryParams () {
				var params = {}
				var questionMarkIndex = window.location.href.indexOf('?');
				if (questionMarkIndex != -1) {
					var pairs = window.location.href.substr(questionMarkIndex + 1).split('&');
					for (i in pairs) {
						var keyValue = pairs[i].split('=', 2);
						if (keyValue.length == 2) {
							params[keyValue[0]] = decodeURIComponent(keyValue[1].replace(/\+/g, '%20'));
						}
					}
				}
				return params;
			}

			function showMessage (message) {
				var div = $('#message');
				if (message != '') {
					div.html(message);
					div.fadeIn(250);
				}
				else {
					div.fadeOut(250);
				}
			}

			function updateHtml () {
				var scrolledToBottom = ($('#html')[0].scrollHeight - $('#html')[0].scrollTop - $('#html')[0].clientHeight == 0);
				$('#html').html(mdeToHtml($('#mde')[0].value, $('#mde')[0].selectionStart));
				if ($('#cursor').length > 0) {
					var scrollTop = $('#html')[0].scrollTop + $('#cursor').offset().top - $('#html').offset().top - ($('#html')[0].clientHeight / 2);
					$('#cursor').remove();
					$('#html').animate({
						scrollTop: scrollTop
					}, 100);
				}
			}

			function swapViews () {
				if ($('#mde').is(":visible")) {
					$('#mde').fadeOut(200, function () {
						$('#html').fadeIn(200);
					});
				}
				else {
					$('#html').fadeOut(200, function () {
						$('#mde').fadeIn(200);
					});
				}
			}

			var params = getQueryParams();

			var password = params['p'];
			var op = params['o'];
			var note = params['n'];

			var driveNotes = null;
			var driveNote = null;

			window.addEventListener('load', function () {
				if (password == undefined) {
					showMessage("You need to specify a password!");
				}
				else {
					$.get('drive_api_key_' + password + '.txt', function (data) {
						var drive = new Drive(data, function () {
							var root = drive.root();
							root.child('Notes', function (driveFile) {
								driveNotes = driveFile;
								if (driveNotes == null) {
									root.createFolder('Notes', function () {
										doNotes();
									});
								}
								else {
									doNotes();
								}
							});
						}, $('#signInButton')[0]);
					});
				}
			});
			window.addEventListener('resize', function () {
				if (window.innerWidth >= 1024) {
					$('#mde').removeAttr('style');
					$('#html').removeAttr('style');
				}
			});

			function doNotes () {
				if (op == 'e') {
					getNote(function (mde) {
						showEditNote(mde);
					});
				}
				else if (op == 'v') {
					getNote(function (mde) {
						showViewNote(mde);
					});
				}
				else if (op == 'd') {
					deleteNote();
				}
				else {
					getNotes(showNotes);
				}
			}

			function getNotes (callback) {
				driveNotes.list(function (notes) {
					for (var i = 0; i < notes.length;) {
						if (!notes[i].endsWith('.mde')) {
							notes.splice(i, 1);
						}
						else {
							notes[i] = notes[i].substr(0, notes[i].length - 4);
							i++;
						}
					}
					callback(notes);
				});
			}

			function showNotes (notes) {
				var html = '';
				html += '<div id="title">Notes</div>';
				html += '<form id="new" action="." method="get">';
				html += '<input type="hidden" name="p" value="' + password + '" />';
				html += '<input type="hidden" name="o" value="e" />';
				html += '<input id="note" type="text" name="n" />';
				html += '<a href="javascript:if ($(\'#note\')[0].value != \'\') $(\'#new\').submit(); else void(0);">New</a>';
				html += '<div class="clear"></div>';
				html += '</form>';

				html += '<div id="list">';
				for (var i in notes) {
					if (notes[i] == '') {
						continue;
					}
					html += '<li><a href="?p=' + password + '&o=v&n=' + notes[i].replace('"', '%22') + '">' + notes[i] + '</a> <a href="?p=' + password + '&n=' + notes[i].replace('"', '%22') + '&o=e"><img src="edit24.png"/></a> <a href="?p=' + password + '&n=' + notes[i].replace('"', '%22') + '&o=d" onclick="return confirm(\'Are you sure?\')"><img src="delete24.png"/></a></li>';
				}
				html += '</div>';
				$('#content').html(html);
			}

			function getNote (callback) {
				driveNotes.child(note + '.mde', function (driveFile) {
					driveNote = driveFile;
					if (driveNote != null) {
						driveNote.get(callback);
					}
					else {
						callback("");
					}
				});
			}

			function showEditNote (mde) {
				var html = '';
				html += '<div id="title">' + note + '</div>';
				html += '<div id="buttons">';
				html += '<a id="swapButton" href="javascript:swapViews();"><img src="swap24.png"/></a>';
				html += '<a href="javascript:save();"><img src="save24.png"/></a>';
				html +=	'<a href=".?p=' + password + '&o=v&n=' + note.replace('"', '%22') + '"><img src="view24.png"/></a>';
				html +=	'<a href=".?p=' + password + '&o=d&n=' + note.replace('"', '%22') + '" onclick="return confirm(\'Are you sure?\')"><img src="delete24.png"/></a>';
				html += '<a href=".?p=' + password + '"><img src="list24.png"/></a>';
				html += '</div>';
				html += '<textarea id="mde" onchange="updateHtml();" onkeyup="updateHtml();">';
				html += mde;
				html += '</textarea>';
				html += '<div id="html">';
				html += mdeToHtml(mde);
				html += '</div>';
				$('#content').html(html);
			}

			function save () {
				showMessage('Saving...');
				var numSaved = 0;
				if (driveNote != null) {
					driveNote.update($('#mde')[0].value, function () {
						numSaved += 1;
						if (numSaved == 2) {
							showMessage('');
						}
					});
					driveNotes.child(note + '.html', function (driveFile) {
						driveFile.update($('#html')[0].innerHTML, function () {
							numSaved += 1;
							if (numSaved == 2) {
								showMessage('');
							}
						});
					});
				}
				else {
					driveNotes.createFile(note + '.mde', 'text/mde', $('#mde')[0].value, function (driveFile) {
						driveNote = driveFile;
						numSaved += 1;
						if (numSaved == 2) {
							showMessage('');
						}
					});
					driveNotes.createFile(note + '.html', 'text/html', $('#html')[0].innerHTML, function (driveFile) {
						numSaved += 1;
						if (numSaved == 2) {
							showMessage('');
						}
					});
				}
			}

			function showViewNote (mde) {
				var html = '';
				html += '<div id="title">' + note + '</div>';
				html += '<div id="buttons">';
				html +=	'<a href=".?p=' + password + '&n=' + note.replace('"', '%22') + '&o=e"><img src="edit24.png"/></a>';
				html +=	'<a href=".?p=' + password + '&o=d&n=' + note.replace('"', '%22') + '" onclick="return confirm(\'Are you sure?\')"><img src="delete24.png"/></a>';
				html += '<a href=".?p=' + password + '"><img src="list24.png"/></a>';
				html += '</div>';
				html += '<div id="html">';
				html += mdeToHtml(mde);
				html += '</div>';
				$('#content').html(html);
			}

			function deleteNote () {
				showMessage('Deleting...');
				var numDeleted = 0;
				driveNotes.child(note + '.mde', function (driveFile) {
					driveFile.delete(function () {
						numDeleted += 1;
						if (numDeleted == 2) {
							window.location.replace('.?p=' + password);
						}
					});
				});
				driveNotes.child(note + '.html', function (driveFile) {
					driveFile.delete(function () {
						numDeleted += 1;
						if (numDeleted == 2) {
							window.location.replace('.?p=' + password);
						}
					});
				});
			}
	</script>
	</head>
	<body>
		<div id='signInButton'>...</div>
		<div id='message'></div>
		<div id='content'></div>
		<div id='clear'></div>
	</body>
</html>